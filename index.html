<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æœ¬è³¼ç‰©æ ¼åƒ¹ç°¿ ğŸŒ¸</title>
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="shortcut icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: { 100: '#fff5f7', 200: '#fecdd3', 500: '#f43f5e', 800: '#881337' },
                    },
                    fontFamily: { sans: ['Noto Sans JP', 'sans-serif'] }
                }
            }
        }
    </script>
<style>
        /* åŠ å…¥å®‰å…¨å€è¨­å®šï¼Œé¿é–‹åŠ‰æµ·åŒ Home Bar */
        body { 
            background-color: #fff5f7; 
            color: #881337;
            /* é—œéµï¼šé˜²æ­¢å·¦å³æ–æ“º */
            overflow-x: hidden; 
            /* é—œéµï¼šç¢ºä¿å…§å®¹å””æœƒè²¼ä½åŠ‰æµ·åŒåº•ç·š */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .item-card { touch-action: manipulation; transition: transform 0.1s; cursor: pointer; }
        .modal { transition: opacity 0.2s; }
        
        /* è§£æ±º iPhone è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§å˜…å•é¡Œ */
        input, select, textarea {
            font-size: 16px !important; 
        }
    </style>
</head>
<body class="w-full max-w-lg mx-auto min-h-screen pb-40 px-3">

    <header class="flex justify-between items-end mb-4 px-1">
        <div>
            <h1 class="text-xl font-bold tracking-widest text-sakura-800">ãŠè²·ã„ç‰©å¸³</h1>
            <p class="text-[10px] text-sakura-500">å¤šåº—èˆ–æ ¼åƒ¹ç‰ˆ</p>
        </div>
        <div class="flex flex-col items-end">
            <label class="text-[10px] text-gray-400">åŒ¯ç‡ (100å††)</label>
            <div class="flex items-center">
                <span class="text-xs mr-1 text-gray-400">HK$</span>
                <input type="number" id="exchangeRate" value="0.52" step="0.01" class="w-12 bg-transparent text-lg font-bold border-b border-sakura-200 text-center" onchange="renderAll()">
            </div>
        </div>
    </header>

    <div class="flex gap-2 mb-6">
        <input type="text" id="newItemName" placeholder="é–‹æ–°é …ç›® (e.g. Dyson é¢¨ç­’)" 
            class="flex-1 p-3 bg-white rounded-xl shadow-sm border border-sakura-200 outline-none">
        <button onclick="createNewItem()" class="bg-sakura-500 text-white px-4 rounded-xl font-bold shadow-md active:scale-95 whitespace-nowrap">
            é–‹å–®
        </button>
    </div>

    <div id="shoppingList" class="space-y-3">
        <p class="text-center text-sakura-500/50 py-10">è¼‰å…¥æ•¸æ“šä¸­...</p>
    </div>

    <div id="editModal" class="modal fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl p-5 h-[90vh] sm:h-auto flex flex-col">
            
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <input type="text" id="modalTitle" class="text-xl font-bold text-gray-800 bg-transparent outline-none w-full" onchange="updateItemName()">
                <button onclick="closeModal()" class="text-gray-400 text-3xl ml-2">&times;</button>
            </div>

            <div class="flex-1 overflow-y-auto mb-4 space-y-2 pr-1" id="modalPriceList">
                </div>

            <div class="bg-sakura-100 p-3 rounded-xl">
                <div class="flex justify-between mb-2">
                    <span class="text-xs font-bold text-sakura-800">æ–°å¢å ±åƒ¹</span>
                    <div class="flex items-center bg-white rounded-full p-1 shadow-sm">
                        <button onclick="setLoc('HK')" id="btnHK" class="px-3 py-1 rounded-full text-xs font-bold transition-all bg-sakura-500 text-white">HK</button>
                        <button onclick="setLoc('JP')" id="btnJP" class="px-3 py-1 rounded-full text-xs font-bold text-gray-400 transition-all">JP</button>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newPriceShop" placeholder="åº—å (e.g. ç™¾ä½³)" class="flex-[2] p-2 rounded-lg text-sm border-none shadow-sm outline-none">
                    <input type="number" id="newPriceVal" placeholder="åƒ¹éŒ¢" class="flex-1 p-2 rounded-lg text-sm border-none shadow-sm outline-none font-mono">
                </div>
                
                <button onclick="addPrice()" class="w-full py-2 bg-sakura-800 text-white rounded-lg text-sm font-bold shadow active:scale-95">
                    ï¼‹ åŠ å…¥åƒ¹éŒ¢
                </button>
            </div>

            <div class="mt-3 pt-2 border-t border-gray-100 text-center">
                <button onclick="deleteItem()" class="text-xs text-red-300 hover:text-red-500">åˆªé™¤æˆä»¶è²¨</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, update } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // âš ï¸ è«‹å¡«å…¥ä½ å˜… Config
        const firebaseConfig = {
Â  apiKey: "AIzaSyDEexFWh65bu1NSgyGNZ1hHnzxBne4f8KI",
Â  authDomain: "japanproduct2026.firebaseapp.com",
Â  databaseURL: "https://japanproduct2026-default-rtdb.firebaseio.com",
Â  projectId: "japanproduct2026",
Â  storageBucket: "japanproduct2026.firebasestorage.app",
Â  messagingSenderId: "935315868288",
Â  appId: "1:935315868288:web:67f05d4feee521ac947465"
};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const listRef = ref(db, 'shopping_list_v2'); // æ”¹å’—å€‹åä»¥å…æ’èˆŠ data

        let localItems = [];
        let currentEditingId = null;
        let currentLoc = 'HK'; // æ–°å¢åƒ¹éŒ¢æ™‚é è¨­åœ°å€

        // ç›£è½æ•¸æ“š
        onValue(listRef, (snapshot) => {
            const data = snapshot.val();
            localItems = [];
            
            if (data) {
                Object.keys(data).forEach(key => {
                    localItems.push({ id: key, ...data[key] });
                });
                localItems.sort((a, b) => (a.order || 0) - (b.order || 0));
            } else {
                // ğŸ”¥ è‡ªå‹•åˆå§‹åŒ–ï¼šå¦‚æœ Database ä¿‚å‰å˜…ï¼Œè‡ªå‹•åŠ å…©ä»¶è²¨
                autoInitData();
            }
            
            renderAll();
            // å¦‚æœé–‹ç·Š Modalï¼Œé †ä¾¿ Refresh åŸ‹ Modal è£¡é¢å˜… list
            if(currentEditingId) {
                renderModalList(currentEditingId);
            }
        });

        // è‡ªå‹•åŠ å…¥é è¨­è²¨å“
        function autoInitData() {
            // åªæœ‰ç•¶ localItems çœŸä¿‚ç©ºå˜…æ™‚å€™å…ˆåš
            if (localItems.length === 0) {
                const initItems = ['å’–å•¡ç£…', 'å¤ªé™½çœ¼é¡'];
                initItems.forEach((name, idx) => {
                    const newRef = push(listRef);
                    set(newRef, { name: name, order: idx, prices: {} });
                });
                // å””ä½¿ alertï¼Œéœéœåœ°åŠ å°±å¾—
            }
        }

        // æ¸²æŸ“ä¸»æ¸…å–®
        window.renderAll = function() {
            const listEl = document.getElementById('shoppingList');
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0.52;
            listEl.innerHTML = '';

            localItems.forEach(item => {
                // è¨ˆç®—æœ€ä½åƒ¹
                let minHK = Infinity;
                let minJP = Infinity; // YEN
                let hasHK = false;
                let hasJP = false;

                if (item.prices) {
                    Object.values(item.prices).forEach(p => {
                        const val = parseFloat(p.value);
                        if (p.loc === 'HK') {
                            if (val < minHK) minHK = val;
                            hasHK = true;
                        } else {
                            if (val < minJP) minJP = val;
                            hasJP = true;
                        }
                    });
                }

                // æ¯”è¼ƒé‚è¼¯
                let statusHtml = '';
                let borderClass = 'border-l-4 border-sakura-200';
                
                if (hasJP) {
                    const minJP_in_HKD = minJP * rate / 100;
                    if (hasHK) {
                        const diff = (minHK - minJP_in_HKD).toFixed(0);
                        if (minJP_in_HKD < minHK) {
                            borderClass = 'border-l-4 border-green-400';
                            statusHtml = `<span class="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å¹³ $${diff}</span>`;
                        } else {
                            statusHtml = `<span class="text-red-400 bg-red-50 px-2 py-1 rounded text-xs font-bold">ğŸ‡­ğŸ‡° é¦™æ¸¯å¹³ $${Math.abs(diff)}</span>`;
                        }
                    } else {
                        statusHtml = `<span class="text-sakura-500 text-xs">åªæœ‰æ—¥åƒ¹</span>`;
                    }
                } else if (hasHK) {
                     statusHtml = `<span class="text-gray-400 text-xs">åªæœ‰æ¸¯åƒ¹</span>`;
                } else {
                     statusHtml = `<span class="text-gray-300 text-xs">æœªæœ‰å ±åƒ¹</span>`;
                }

                // é¡¯ç¤ºæœ€å¹³åƒ¹éŒ¢
                const showHK = hasHK ? `$${minHK}` : '--';
                const showJP = hasJP ? `Â¥${minJP}` : '--';

                const html = `
                    <div class="item-card bg-white p-4 rounded-xl shadow-sm ${borderClass} relative" onclick="openModal('${item.id}')" data-id="${item.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                            ${statusHtml}
                        </div>
                        <div class="flex text-sm items-center gap-4 text-gray-600">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 uppercase">æœ€å¹³ HK</span>
                                <span class="font-mono font-medium">${showHK}</span>
                            </div>
                            <div class="w-px h-6 bg-gray-100"></div>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 uppercase">æœ€å¹³ JP</span>
                                <span class="font-mono font-medium">${showJP}</span>
                            </div>
                        </div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', html);
            });
        }

        // é–‹æ–° Item
        window.createNewItem = function() {
            const name = document.getElementById('newItemName').value;
            if(!name) return;
            const newRef = push(listRef);
            set(newRef, {
                name: name,
                order: localItems.length,
                prices: {}
            });
            document.getElementById('newItemName').value = '';
        }

        // Modal é‚è¼¯
        window.openModal = function(id) {
            currentEditingId = id;
            const item = localItems.find(i => i.id === id);
            document.getElementById('modalTitle').value = item.name;
            document.getElementById('editModal').classList.remove('hidden');
            
            // é‡ç½®è¼¸å…¥æ¬„
            document.getElementById('newPriceShop').value = '';
            document.getElementById('newPriceVal').value = '';
            
            renderModalList(id);
        }

        window.closeModal = function() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditingId = null;
        }

        window.renderModalList = function(id) {
            const item = localItems.find(i => i.id === id);
            const container = document.getElementById('modalPriceList');
            container.innerHTML = '';

            if (!item.prices) {
                container.innerHTML = '<p class="text-center text-gray-300 text-sm py-4">æš«æœªæœ‰å ±åƒ¹</p>';
                return;
            }

            const pricesArr = Object.keys(item.prices).map(key => ({ pid: key, ...item.prices[key] }));
            
            // æŒ‰åƒ¹éŒ¢æ’åº (HKD å…ˆ, JPY å¾Œ)
            pricesArr.sort((a,b) => (a.loc === b.loc) ? 0 : (a.loc === 'HK' ? -1 : 1));

            pricesArr.forEach(p => {
                const isHK = p.loc === 'HK';
                const el = document.createElement('div');
                el.className = `flex justify-between items-center p-3 rounded-lg border ${isHK ? 'bg-gray-50 border-gray-100' : 'bg-sakura-50 border-sakura-100'}`;
                el.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${isHK ? 'bg-gray-200 text-gray-600' : 'bg-sakura-200 text-sakura-800'}">${p.loc}</span>
                        <span class="text-sm font-medium text-gray-700">${p.shop}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold ${isHK ? 'text-gray-800' : 'text-sakura-600'}">${isHK ? '$' : 'Â¥'}${p.value}</span>
                        <button onclick="removePrice('${item.id}', '${p.pid}')" class="text-gray-300 hover:text-red-400 px-1">Ã—</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // æ–°å¢åƒ¹éŒ¢
        window.setLoc = function(loc) {
            currentLoc = loc;
            const btnHK = document.getElementById('btnHK');
            const btnJP = document.getElementById('btnJP');
            if(loc === 'HK') {
                btnHK.className = "px-3 py-1 rounded-full text-xs font-bold transition-all bg-sakura-500 text-white shadow";
                btnJP.className = "px-3 py-1 rounded-full text-xs font-bold transition-all text-gray-400";
            } else {
                btnHK.className = "px-3 py-1 rounded-full text-xs font-bold transition-all text-gray-400";
                btnJP.className = "px-3 py-1 rounded-full text-xs font-bold transition-all bg-sakura-500 text-white shadow";
            }
        }

        window.addPrice = function() {
            if(!currentEditingId) return;
            const shop = document.getElementById('newPriceShop').value || (currentLoc==='HK'?'é¦™æ¸¯æŸåº—':'æ—¥æœ¬æŸåº—');
            const val = document.getElementById('newPriceVal').value;
            
            if(!val) return alert('è«‹è¼¸å…¥åƒ¹éŒ¢');

            const priceRef = push(ref(db, `shopping_list_v2/${currentEditingId}/prices`));
            set(priceRef, {
                loc: currentLoc,
                shop: shop,
                value: parseFloat(val),
                timestamp: Date.now()
            });

            document.getElementById('newPriceShop').value = '';
            document.getElementById('newPriceVal').value = '';
        }

        window.removePrice = function(itemId, priceId) {
            if(confirm('åˆªé™¤æ­¤å ±åƒ¹ï¼Ÿ')) {
                remove(ref(db, `shopping_list_v2/${itemId}/prices/${priceId}`));
            }
        }

        window.updateItemName = function() {
            if(!currentEditingId) return;
            const newName = document.getElementById('modalTitle').value;
            update(ref(db, `shopping_list_v2/${currentEditingId}`), { name: newName });
        }

        window.deleteItem = function() {
            if(confirm('ç¢ºå®šåˆªé™¤æˆå€‹é …ç›®ï¼Ÿæ‰€æœ‰å ±åƒ¹æœƒæ¶ˆå¤±ã€‚')) {
                remove(ref(db, `shopping_list_v2/${currentEditingId}`));
                closeModal();
            }
        }

        // Sortable
        new Sortable(document.getElementById('shoppingList'), {
            animation: 150,
            ghostClass: 'ghost',
            delay: 100,
            delayOnTouchOnly: true,
            onEnd: function (evt) {
                const itemEls = document.querySelectorAll('.item-card');
                const updates = {};
                itemEls.forEach((el, index) => {
                    updates[`shopping_list_v2/${el.dataset.id}/order`] = index;
                });
                update(ref(db), updates);
            }
        });
        
        // é»èƒŒæ™¯é—œé–‰
        document.getElementById('editModal').addEventListener('click', (e) => {
            if(e.target === document.getElementById('editModal')) closeModal();
        });
    </script>
</body>
</html>
